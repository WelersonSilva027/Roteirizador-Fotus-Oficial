<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enviar Cota√ß√£o - FOTUS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; }
        .card-header-custom { background: linear-gradient(135deg, #0d6efd, #0043a8); color: white; border-radius: 12px 12px 0 0 !important; }
        .btn-submit { background-color: #198754; color: white; font-weight: bold; padding: 12px; }
        .detail-row { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding: 8px 0; font-size: 0.9rem; }
        .detail-label { color: #6c757d; }
        .detail-value { font-weight: bold; color: #212529; text-align: right; }
        
        /* TIMELINE (ROTEIRO) */
        .timeline { position: relative; padding-left: 20px; margin-top: 15px; border-left: 2px solid #dee2e6; }
        .timeline-item { position: relative; margin-bottom: 15px; padding-left: 10px; }
        .timeline-item::before { content: ''; position: absolute; left: -26px; top: 5px; width: 12px; height: 12px; border-radius: 50%; background: #fff; border: 3px solid #0d6efd; }
        .timeline-item.origin::before { border-color: #dc3545; background: #dc3545; } /* Origem Vermelha */
        .city-name { font-weight: bold; font-size: 0.9rem; color: #212529; display: block; }
        .city-meta { font-size: 0.75rem; color: #6c757d; }
    </style>
</head>
<body>
    
<div class="bg-white border-bottom py-2 px-3 mb-3 d-flex justify-content-between align-items-center shadow-sm">
    <small class="text-muted fw-bold">FOTUS</small>
    <a href="vagas.html" class="text-decoration-none small fw-bold text-primary">
        <i class="fas fa-th-list"></i> Voltar ao Mural
    </a>
</div>

<div class="container py-2" style="max-width: 600px;">
    
    <div class="card shadow-sm mb-3 border-0 rounded-3">
        <div class="card-header card-header-custom p-3 text-center">
            <h5 class="m-0 fw-bold" id="opTitle">Carregando...</h5>
            <small class="opacity-75" id="opId">ID: --</small>
        </div>
        <div class="card-body p-3">
            <div class="row g-2 mb-3">
                <div class="col-6">
                    <div class="bg-light p-2 rounded text-center border">
                        <small class="text-muted d-block" style="font-size:0.7rem">PESO TOTAL</small>
                        <strong class="text-dark" id="lblPeso">--</strong>
                    </div>
                </div>
                <div class="col-6">
                    <div class="bg-light p-2 rounded text-center border">
                        <small class="text-muted d-block" style="font-size:0.7rem">VALOR CARGA</small>
                        <strong class="text-success" id="lblValorCarga">--</strong>
                    </div>
                </div>
            </div>

            <div class="detail-row"><span class="detail-label">Ve√≠culo:</span> <span class="detail-value" id="lblVeiculo">--</span></div>
            <div class="detail-row"><span class="detail-label">Dist√¢ncia Estimada:</span> <span class="detail-value" id="lblDist">--</span></div>
            
            <div class="mt-4">
                <h6 class="fw-bold text-secondary small border-bottom pb-1 mb-2">üìç ROTEIRO DE ENTREGA</h6>
                <div class="timeline" id="roteiroTimeline">
                    </div>
                
                <button class="btn btn-outline-primary btn-sm w-100 mt-2 fw-bold" id="btnGoogleMaps" onclick="abrirGoogleMapsExterno()">
                    <i class="fas fa-map-marked-alt"></i> VER TRAJETO NO MAPA
                </button>
            </div>
        </div>
    </div>

    <div class="card shadow border-0 rounded-3" id="formCard">
        <div class="card-body p-4">
            <h6 class="fw-bold mb-3 text-primary"><i class="fas fa-hand-holding-usd"></i> Enviar Proposta</h6>
            
            <form id="bidForm" onsubmit="enviarCota√ß√£o(event)">
                <div class="mb-3">
                    <label class="form-label small fw-bold">Seu Nome / Motorista</label>
                    <input type="text" id="motorista" class="form-control bg-light" placeholder="Ex: Jo√£o Silva" required>
                </div>
                
                <div class="mb-3">
                    <label class="form-label small fw-bold">Transportadora (Opcional)</label>
                    <input type="text" id="empresa" class="form-control bg-light" placeholder="Ex: TransSilva">
                </div>

                <div class="row">
                    <div class="col-6 mb-3">
                        <label class="form-label small fw-bold text-success">Valor do Frete (R$)</label>
                        <input type="number" id="valor" class="form-control form-control-lg fw-bold text-success border-success" placeholder="0.00" step="0.01" required>
                    </div>
                    <div class="col-6 mb-3">
                        <label class="form-label small fw-bold">Prazo (Dias)</label>
                        <input type="number" id="prazo" class="form-control form-control-lg" placeholder="Ex: 2" required>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label small fw-bold">Modalidade</label>
                    <select id="modalidade" class="form-select bg-light">
                        <option value="Dedicado/Itinerante">Dedicado / Itinerante</option>
                        <option value="Fracionado">Fracionado</option>
                        <option value="Lota√ß√£o">Lota√ß√£o / Retorno</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label small fw-bold">Observa√ß√µes</label>
                    <textarea id="obs" class="form-control bg-light" rows="2" placeholder="Ex: Preciso de adiantamento..."></textarea>
                </div>

                <button type="submit" class="btn btn-submit w-100 shadow rounded-pill text-uppercase">
                    Confirmar Envio <i class="fas fa-paper-plane ms-2"></i>
                </button>
            </form>
        </div>
    </div>

    <div id="successMsg" class="text-center mt-5" style="display:none;">
        <div class="display-1 text-success mb-3"><i class="fas fa-check-circle"></i></div>
        <h3 class="fw-bold text-dark">Proposta Enviada!</h3>
        <p class="text-muted mb-4">Sua oferta foi registrada com sucesso.</p>
        <div class="d-grid gap-2 col-10 mx-auto">
            <a href="vagas.html" class="btn btn-primary btn-lg fw-bold shadow rounded-pill">
                <i class="fas fa-list-alt"></i> VER MAIS CARGAS
            </a>
        </div>
    </div>
    
    <div class="text-center mt-4 mb-3 text-muted small">
        ¬© 2025 FOTUS Log√≠stica
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyARALEOLxIb7TlsSRqI0fdNfY8D-SgcYbY",
        authDomain: "roteirizadorfotus.firebaseapp.com",
        projectId: "roteirizadorfotus",
        storageBucket: "roteirizadorfotus.firebasestorage.app",
        messagingSenderId: "597979098930",
        appId: "1:597979098930:web:b8fb54a0ffc160e39a312b",
        measurementId: "G-Z3P42WF5HD"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const urlParams = new URLSearchParams(window.location.search);
    const opId = urlParams.get('op');
    let rotaGlobal = null; // Para usar no bot√£o do mapa

    if(!opId) document.body.innerHTML = "<h3 class='text-center mt-5 text-danger'>Link Inv√°lido</h3>";

    // CARREGAR DADOS
    db.collection("historico").where("id_operacao", "==", opId).limit(1).get().then(snapshot => {
        if(snapshot.empty) {
            document.body.innerHTML = "<div class='alert alert-warning m-3'>Esta carga n√£o est√° mais dispon√≠vel.</div>";
            return;
        }
        
        const doc = snapshot.docs[0].data();
        let detalhes = {};
        try { detalhes = JSON.parse(doc.dados_json); } catch(e){}
        
        rotaGlobal = detalhes; // Salva para o mapa

        document.getElementById('opTitle').innerText = doc.nome_rota || "Rota sem nome";
        document.getElementById('opId').innerText = `ID: ${doc.id_operacao}`;
        document.getElementById('lblVeiculo').innerText = doc.veiculo;
        document.getElementById('lblPeso').innerText = (detalhes.peso_total || 0).toLocaleString('pt-BR') + " kg";
        document.getElementById('lblDist').innerText = (doc.total_km || 0).toFixed(1) + " km";
        document.getElementById('lblValorCarga').innerText = (detalhes.valor_total || 0).toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});

        // MONTAR TIMELINE (ROTEIRO)
        const timeline = document.getElementById('roteiroTimeline');
        timeline.innerHTML = "";

        // 1. Origem
        const origemNome = detalhes.origem ? detalhes.origem.nome : "CD Origem";
        timeline.innerHTML += `
        <div class="timeline-item origin">
            <span class="city-name text-danger">ORIGEM: ${origemNome}</span>
            <span class="city-meta">Ponto de Coleta</span>
        </div>`;

        // 2. Pedidos/Cidades
        if(detalhes.pedidos && detalhes.pedidos.length > 0) {
            detalhes.pedidos.forEach((p, idx) => {
                // Tenta limpar o endere√ßo para mostrar Cidade - UF
                let textoExibicao = p.ENDERECO;
                // Se tiver UF separado, tenta destacar
                const meta = p.UF && p.UF.length === 2 ? `${p.PESO}kg ‚Ä¢ ${p.UF}` : `${p.PESO}kg`;
                
                timeline.innerHTML += `
                <div class="timeline-item">
                    <span class="city-name">${textoExibicao}</span>
                    <span class="city-meta">Entrega #${idx+1} (${meta})</span>
                </div>`;
            });
        }
    });

    function abrirGoogleMapsExterno() {
        if(!rotaGlobal || !rotaGlobal.origem || !rotaGlobal.pedidos) return alert("Erro nos dados da rota.");
        
        const origin = `${rotaGlobal.origem.coords[1]},${rotaGlobal.origem.coords[0]}`;
        const destinations = rotaGlobal.pedidos.map(p => `${p.lat},${p.lon}`).join('/');
        
        // Abre URL direta do Google Maps Directions
        const url = `https://www.google.com/maps/dir/${origin}/${destinations}`;
        window.open(url, '_blank');
    }

    function enviarCota√ß√£o(e) {
        e.preventDefault();
        const btn = document.querySelector('.btn-submit');
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
        btn.disabled = true;

        const data = {
            id_operacao: opId,
            motorista: document.getElementById('motorista').value,
            empresa: document.getElementById('empresa').value,
            valor_oferta: parseFloat(document.getElementById('valor').value),
            prazo: document.getElementById('prazo').value + " dias",
            modalidade: document.getElementById('modalidade').value,
            obs: document.getElementById('obs').value,
            registrado_por: "Portal Web",
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };

        db.collection("cotacoes").add(data).then(() => {
            document.getElementById('formCard').style.display = 'none';
            document.getElementById('successMsg').style.display = 'block';
            window.scrollTo(0,0);
        }).catch(err => {
            alert("Erro: " + err.message);
            btn.disabled = false;
            btn.innerText = "TENTAR NOVAMENTE";
        });
    }
</script>
</body>
</html>