<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enviar Cota√ß√£o - FOTUS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/imask"></script>

    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; }
        .card-header-custom { background: linear-gradient(135deg, #0d6efd, #0043a8); color: white; border-radius: 12px 12px 0 0 !important; }
        .btn-submit { background-color: #198754; color: white; font-weight: bold; padding: 12px; transition: all 0.3s; }
        .btn-submit:hover { background-color: #146c43; transform: translateY(-2px); }
        .detail-row { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding: 8px 0; font-size: 0.9rem; }
        .detail-label { color: #6c757d; }
        .detail-value { font-weight: bold; color: #212529; text-align: right; }
        
        /* TIMELINE */
        .timeline { position: relative; padding-left: 20px; margin-top: 15px; border-left: 2px solid #dee2e6; }
        .timeline-item { position: relative; margin-bottom: 15px; padding-left: 10px; }
        .timeline-item::before { content: ''; position: absolute; left: -26px; top: 5px; width: 12px; height: 12px; border-radius: 50%; background: #fff; border: 3px solid #0d6efd; }
        .timeline-item.origin::before { border-color: #dc3545; background: #dc3545; }
        .city-name { font-weight: bold; font-size: 0.9rem; color: #212529; display: block; }
        .city-meta { font-size: 0.75rem; color: #6c757d; }
    </style>
</head>
<body>
    
<div class="bg-white border-bottom py-2 px-3 mb-3 d-flex justify-content-between align-items-center shadow-sm">
    <small class="text-muted fw-bold">FOTUS LOG√çSTICA</small>
    <a href="vagas.html" class="text-decoration-none small fw-bold text-primary">
        <i class="fas fa-th-list"></i> Voltar ao Mural
    </a>
</div>

<div class="container py-2" style="max-width: 600px;">
    
    <div class="card shadow-sm mb-3 border-0 rounded-3">
        <div class="card-header card-header-custom p-3 text-center">
            <h5 class="m-0 fw-bold" id="opTitle">Carregando...</h5>
            <small class="opacity-75" id="opId">ID: --</small>
        </div>
        <div class="card-body p-3">
            <div class="row g-2 mb-3">
                <div class="col-6">
                    <div class="bg-light p-2 rounded text-center border">
                        <small class="text-muted d-block" style="font-size:0.7rem">PESO TOTAL</small>
                        <strong class="text-dark" id="lblPeso">--</strong>
                    </div>
                </div>
                <div class="col-6">
                    <div class="bg-light p-2 rounded text-center border">
                        <small class="text-muted d-block" style="font-size:0.7rem">VALOR CARGA</small>
                        <strong class="text-success" id="lblValorCarga">--</strong>
                    </div>
                </div>
            </div>

            

            <div class="detail-row"><span class="detail-label">Ve√≠culo Necess√°rio:</span> <span class="detail-value" id="lblVeiculo">--</span></div>
            <div class="detail-row"><span class="detail-label">Dist√¢ncia Estimada:</span> <span class="detail-value" id="lblDist">--</span></div>
            
            <div class="mt-4">
                <h6 class="fw-bold text-secondary small border-bottom pb-1 mb-2">üìç ROTEIRO DA VIAGEM</h6>
                <div class="timeline" id="roteiroTimeline"></div>
                <button class="btn btn-outline-primary btn-sm w-100 mt-2 fw-bold" id="btnGoogleMaps" onclick="abrirGoogleMapsExterno()">
                    <i class="fas fa-map-marked-alt"></i> VER NO GOOGLE MAPS
                </button>
            </div>
        </div>
    </div>

    <div class="card shadow border-0 rounded-3" id="formCard">
        <div class="card-body p-4">
            <h6 class="fw-bold mb-3 text-primary"><i class="fas fa-hand-holding-usd"></i> Enviar Proposta</h6>
            <div class="alert alert-warning small"><i class="fas fa-exclamation-circle"></i> Seus dados ser√£o salvos para receber futuras ofertas automaticamente.</div>
            
            <form id="bidForm" onsubmit="enviarCota√ß√£o(event)">
                
                <div class="row mb-3">
                    <div class="col-12 mb-2">
                        <label class="form-label small fw-bold">Seu Nome Completo</label>
                        <input type="text" id="motorista" class="form-control bg-light" placeholder="Ex: Jo√£o Silva" required>
                    </div>
                    <div class="col-6">
                        <label class="form-label small fw-bold">WhatsApp / Celular</label>
                        <input type="tel" id="contatoTel" class="form-control bg-light" placeholder="(00) 00000-0000" required>
                    </div>
                    <div class="col-6">
                        <label class="form-label small fw-bold">E-mail</label>
                        <input type="email" id="contatoEmail" class="form-control bg-light" placeholder="email@exemplo.com" required>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label small fw-bold">Transportadora (Opcional)</label>
                    <input type="text" id="empresa" class="form-control bg-light" placeholder="Ex: TransSilva">
                </div>

                <hr>

                <div id="boxTarget" class="card border-success mb-3 shadow-sm" style="display:none; background-color: #d1e7dd;">
    <div class="card-body text-center p-2">
        <small class="text-success fw-bold text-uppercase" style="letter-spacing: 1px;">
            <i class="fas fa-bullseye"></i> Meta de Frete / Target
        </small>
        <div class="h2 fw-bold text-dark m-0 mt-1" id="lblTargetValue">R$ --</div>
        <small class="text-muted fst-italic" style="font-size: 0.75rem;">
            Tente enviar sua oferta pr√≥xima a este valor.
        </small>
    </div>
</div>

                <div class="row">
                    <div class="col-6 mb-3">
                        <label class="form-label small fw-bold text-success">Valor do Frete (R$)</label>
                        <input type="number" id="valor" class="form-control form-control-lg fw-bold text-success border-success" placeholder="0.00" step="0.01" required>
                    </div>
                    <div class="col-6 mb-3">
                        <label class="form-label small fw-bold">Prazo (Dias)</label>
                        <input type="number" id="prazo" class="form-control form-control-lg" placeholder="Ex: 2" required>
                    </div>
                </div>


                <div class="mb-3">
                    <label class="form-label small fw-bold">Modalidade</label>
                    <select id="modalidade" class="form-select bg-light">
                        <option value="Dedicado/Itinerante">Dedicado / Itinerante</option>
                        <option value="Fracionado">Fracionado</option>
                        <option value="Lota√ß√£o">Lota√ß√£o / Retorno</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label small fw-bold">Observa√ß√µes</label>
                    <textarea id="obs" class="form-control bg-light" rows="2" placeholder="Ex: Preciso de adiantamento, carrego amanh√£..."></textarea>
                </div>

                <button type="submit" class="btn btn-submit w-100 shadow rounded-pill text-uppercase">
                    Confirmar Envio <i class="fas fa-paper-plane ms-2"></i>
                </button>
            </form>
        </div>
    </div>

    <div id="successMsg" class="text-center mt-5" style="display:none;">
        <div class="display-1 text-success mb-3"><i class="fas fa-check-circle"></i></div>
        <h3 class="fw-bold text-dark">Proposta Enviada!</h3>
        <p class="text-muted mb-4">Sua oferta foi registrada e seus dados foram atualizados em nosso cadastro.</p>
        <div class="d-grid gap-2 col-10 mx-auto">
            <a href="vagas.html" class="btn btn-primary btn-lg fw-bold shadow rounded-pill">
                <i class="fas fa-list-alt"></i> VER MAIS CARGAS
            </a>
        </div>
    </div>
    
    <div class="text-center mt-4 mb-3 text-muted small">Fotus Distribuidora Solar ¬© 2025</div>
</div>

<script>
    // CONFIGURA√á√ÉO FIREBASE
    const firebaseConfig = {
        apiKey: "AIzaSyARALEOLxIb7TlsSRqI0fdNfY8D-SgcYbY",
        authDomain: "roteirizadorfotus.firebaseapp.com",
        projectId: "roteirizadorfotus",
        storageBucket: "roteirizadorfotus.firebasestorage.app",
        messagingSenderId: "597979098930",
        appId: "1:597979098930:web:b8fb54a0ffc160e39a312b",
        measurementId: "G-Z3P42WF5HD"
    };
    
    // Inicializa Firebase apenas uma vez
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Pega o ID da URL
    const urlParams = new URLSearchParams(window.location.search);
    const opId = urlParams.get('op');
    let rotaGlobal = null;

    // Se n√£o tiver ID na URL, mostra erro
    if(!opId) {
        document.body.innerHTML = "<div class='container mt-5'><div class='alert alert-danger text-center shadow'><h4>Link Inv√°lido ou Incompleto</h4><p>Verifique o link enviado.</p></div></div>";
    }

    // M√ÅSCARA DE TELEFONE
    document.addEventListener('DOMContentLoaded', () => {
        const telInput = document.getElementById('contatoTel');
        if(telInput && window.IMask) {
            IMask(telInput, { mask: '(00) 00000-0000' });
        }
        
        // Se tiver ID, carrega os dados
        if(opId) carregarDadosRota();
    });

    // FUN√á√ÉO PARA CARREGAR DADOS DA ROTA
    function carregarDadosRota() {
        db.collection("historico").where("id_operacao", "==", opId).limit(1).get()
        .then(snapshot => {
            if(snapshot.empty) {
                document.body.innerHTML = "<div class='container mt-5'><div class='alert alert-warning text-center shadow'><h5>Carga Indispon√≠vel</h5><p>Esta rota pode ter sido removida ou j√° finalizada.</p><a href='vagas.html' class='btn btn-primary'>Ver Outras Cargas</a></div></div>";
                return;
            }

            const doc = snapshot.docs[0].data();
            let detalhes = {};
            try { detalhes = JSON.parse(doc.dados_json); } catch(e){ console.error("Erro ao ler JSON", e); }
            rotaGlobal = detalhes;

            // Preenche dados b√°sicos
            document.getElementById('opTitle').innerText = doc.nome_rota || "Rota";
            document.getElementById('opId').innerText = `ID: ${doc.id_operacao}`;
            document.getElementById('lblVeiculo').innerText = doc.veiculo || "N/A";
            
            // Formata√ß√µes num√©ricas
            const peso = detalhes.peso_total || 0;
            const valorCarga = detalhes.valor_total || 0;
            const km = doc.total_km || 0;

            document.getElementById('lblPeso').innerText = peso.toLocaleString('pt-BR') + " kg";
            document.getElementById('lblDist').innerText = km.toFixed(1) + " km";
            document.getElementById('lblValorCarga').innerText = valorCarga.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});

            // === L√ìGICA DO TARGET (META) ===
            const boxTarget = document.getElementById('boxTarget');
            const lblTarget = document.getElementById('lblTargetValue');
            
            // Verifica se o campo existe no banco e √© maior que zero
            if (doc.target_price && Number(doc.target_price) > 0) {
                lblTarget.innerText = Number(doc.target_price).toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
                boxTarget.style.display = 'block'; // Mostra a caixa
                console.log("Target encontrado:", doc.target_price);
            } else {
                boxTarget.style.display = 'none'; // Esconde
                console.log("Sem target definido.");
            }
            // ================================

            // Monta Timeline (Roteiro)
            const timeline = document.getElementById('roteiroTimeline');
            timeline.innerHTML = "";
            
            const origemNome = detalhes.origem ? detalhes.origem.nome : "Origem";
            timeline.innerHTML += `<div class="timeline-item origin"><span class="city-name text-danger">ORIGEM: ${origemNome}</span><span class="city-meta">Coleta</span></div>`;
            
            if(detalhes.pedidos && detalhes.pedidos.length > 0) {
                detalhes.pedidos.forEach((p, idx) => {
                    const meta = p.UF ? `${p.PESO}kg ‚Ä¢ ${p.UF}` : `${p.PESO}kg`;
                    timeline.innerHTML += `<div class="timeline-item"><span class="city-name">${p.ENDERECO}</span><span class="city-meta">Entrega #${idx+1} (${meta})</span></div>`;
                });
            }
        })
        .catch(err => {
            console.error("Erro ao buscar rota:", err);
            alert("Erro ao carregar dados da rota.");
        });
    }

    function abrirGoogleMapsExterno() {
        if(!rotaGlobal || !rotaGlobal.origem || !rotaGlobal.pedidos) return alert("Erro nos dados de geolocaliza√ß√£o.");
        const origin = `${rotaGlobal.origem.coords[1]},${rotaGlobal.origem.coords[0]}`;
        const destinations = rotaGlobal.pedidos.map(p => `${p.lat},${p.lon}`).join('/');
        window.open(`https://www.google.com/maps/dir/${origin}/${destinations}`, '_blank');
    }

    // --- ENVIAR COTA√á√ÉO ---
    function enviarCota√ß√£o(e) {
        e.preventDefault();
        const btn = document.querySelector('.btn-submit');
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processando...';
        btn.disabled = true;

        const nome = document.getElementById('motorista').value;
        const empresa = document.getElementById('empresa').value;
        const email = document.getElementById('contatoEmail').value.trim().toLowerCase();
        const telefone = document.getElementById('contatoTel').value;
        const valorOferta = parseFloat(document.getElementById('valor').value);

        if(!valorOferta || valorOferta <= 0) {
            alert("Digite um valor v√°lido.");
            btn.disabled = false; btn.innerHTML = "CONFIRMAR ENVIO";
            return;
        }

        // 1. Objeto da Oferta
        const ofertaData = {
            id_operacao: opId,
            motorista: nome,
            empresa: empresa,
            contato_email: email,
            contato_tel: telefone,
            valor_oferta: valorOferta,
            prazo: document.getElementById('prazo').value + " dias",
            modalidade: document.getElementById('modalidade').value,
            obs: document.getElementById('obs').value,
            registrado_por: "Portal Web",
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };

        // 2. Objeto do Cadastro
        const cadastroData = {
            nome: nome,
            empresa: empresa,
            email: email,
            telefone: telefone,
            ultimo_lance_em: firebase.firestore.FieldValue.serverTimestamp(),
            origem_cadastro: "Portal de Cota√ß√£o",
            status_ativo: true
        };

        const batch = db.batch();

        // Salva Oferta
        const ofertaRef = db.collection("cotacoes").doc(); 
        batch.set(ofertaRef, ofertaData);

        // Salva/Atualiza Cadastro (ID = email limpo)
        const cadastroId = email.replace(/[^a-zA-Z0-9]/g, "_");
        if(cadastroId) {
            const cadastroRef = db.collection("transportadores_cadastrados").doc(cadastroId);
            batch.set(cadastroRef, cadastroData, { merge: true });
        }

        batch.commit().then(() => {
            document.getElementById('formCard').style.display = 'none';
            document.getElementById('successMsg').style.display = 'block';
            window.scrollTo(0,0);
        }).catch(err => {
            console.error(err);
            alert("Erro ao enviar: " + err.message);
            btn.disabled = false;
            btn.innerHTML = 'TENTAR NOVAMENTE';
        });
    }
</script>
</body>
</html>